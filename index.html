<!DOCTYPE html>
<html>
<head>
    <title>Projet 5BLOC</title>
</head>
<body>
    <div id="realestate">

    </div>
    <div>
        <input type="text" id="nameRe">
        <input type="text" id="priceRe">
        <input type="text" id="imgRe">
        <button id="createRe">Increment</button>
        <button id="transfertRe">Increment</button>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous" ></script>
    

    <script>
        var realestateContract;
        var userAccount;

        function startApp() {

            var address = "0x2f3C7A372Ccb7eEd4C4Af74A8E4217E6401606e9";
            var abi = [
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_to",
                        "type": "address"
                    },
                    {
                        "name": "_realestateId",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_name",
                        "type": "string"
                    },
                    {
                        "name": "_price",
                        "type": "uint256"
                    },
                    {
                        "name": "_realestateImages",
                        "type": "string"
                    }
                ],
                "name": "createRealEstate",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "name": "realEstateId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "name": "salerAddress",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "name": "images",
                        "type": "string"
                    }
                ],
                "name": "NewRealEstate",
                "type": "event"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_realestateId",
                        "type": "uint256"
                    }
                ],
                "name": "takeOwnership",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_to",
                        "type": "address"
                    },
                    {
                        "name": "_realestateId",
                        "type": "uint256"
                    }
                ],
                "name": "transfer",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "name": "_from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "name": "_to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "name": "_tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "name": "_owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "name": "_approved",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "name": "_tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Approval",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "_owner",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "name": "_balance",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "getAllRealestates",
                "outputs": [
                    {
                        "name": "",
                        "type": "uint256[]"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "_realestateId",
                        "type": "uint256"
                    }
                ],
                "name": "ownerOf",
                "outputs": [
                    {
                        "name": "_owner",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "realestates",
                "outputs": [
                    {
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "name": "salerAddress",
                        "type": "address"
                    },
                    {
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "name": "images",
                        "type": "string"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "realestateToOwner",
                "outputs": [
                    {
                        "name": "",
                        "type": "address"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            }
        ];

            realestateContract = new web3js.eth.Contract(abi, address);

            console.log('TEST2');

            getRealestates().then(displayRealestates);

           var accountInterval = setInterval(function() {
            // Check if account has changed
            if (ethereum.request({ method: 'eth_accounts' })[0] !== userAccount) {
                userAccount = ethereum.request({ method: 'eth_accounts' })[0];
                // Call a function to update the UI with the new account
                getRealestates()
                .then(displayRealestates);
                console.log('TEST3');
            }
            }, 100); 

            /*realestateContract.methods.getCount().call().then(function (bal) 
            {
                $('#balance').html(bal);
            })*/
        }


        function displayRealestates(ids) {
            $("#realestate").empty();
            for (id of ids) {
            // Look up realestate details from our contract. Returns a `realestate` object
            getRealestatesDetails(id)
            .then(function(realestate) {
                // Using ES6's "template literals" to inject variables into the HTML.
                // Append each one to our #zombies div
                $("#realestate").append(`<div class="realestate">
                <ul>
                    <li>Name: ${realestate.name}</li>
                    <li>Price: ${realestate.price}</li>
                    <li>Image: ${realestate.image}</li>
                    <li>Saler: ${realestate.salerAddress}</li>
                </ul>
                </div>`);
            });
            }
        }


        function getRealestatesDetails(id) {
            return realestateContract.methods.realestates(id).call()
        }

        function realestateToOwner(id) {
            return realestateContract.methods.realestateToOwner(id).call()
        }

        function getRealestates() {
            return realestateContract.methods.getAllRealestates().call()
        }



        $('#createRe').click(function () 
        {
                
             
        })


        $(document).ready(function() 
        {

            // Checking if Web3 has been injected by the browser (Mist/MetaMask)
            if (typeof web3 !== 'undefined') {
            // Use Mist/MetaMask's provider
            web3js = new Web3(web3.currentProvider);
            } else {
            // Handle the case where the user doesn't have MetaMask installed
            // Probably show them a message prompting them to install MetaMask
                console.log("load matamask");
            }

            startApp();
            console.log('test1');



        })


    </script>


</body>
</html>
